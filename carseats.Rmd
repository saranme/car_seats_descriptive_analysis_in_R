---
title: "carseats"
author: "sara navarro medina"
date: "10/01/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(arules)
library(sjstats)
library(ggplot2)
library(R.matlab)
library(ISLR)
library(ggsci)
library(hrbrthemes)

df = ISLR::Carseats
head(df)
```

```{r}
# Display Structure of Data Frame.
str(df)
```

```{r}
# Check nulls per variable.
lapply(df,function(x) { length(which(is.na(x)))})
```

Las variables no tienen valores nulos.
```{r}
# Select just numerical features
nums <- unlist(lapply(df, is.numeric))

for (var in names(df[, nums])) {
  print(var)
  print(summary(df[,c(var)]))
  boxplot(df[,c(var)], main = paste0(var," boxplot"))
}
```

```{r}
# Select just categorical features
cat <- unlist(lapply(df, is.factor))

for (var in names(df[, cat])) {
  print(var)
  print(table(df[,c(var)]))
  print(round(prop.table(table(df[,c(var)])),2))
}
```
Hay el doble más de tiendas con asientos de coches en el estante medio que tiendas con asientos de coches en el estante malo o bueno.

El 30% de las tiendas están en zona rural.

El 36% de las tiendas no están en US.

```{r}
# New variable with ages by interval
df$Age_cat <- cut(df$Age, breaks = c(25,30,35,40,45,65,80),
      labels = c("25-30","30-35","35-40","40-45","45-65","65-80"),
      include.lowest = TRUE)
# New variable with sales classified as low, medium, high and very high
df$Sales_cat <- cut(df$Sales, breaks = c(0,5.39,7.49,9.32,16.27), labels = c("bajas", "medias","altas","muy altas"),include.lowest = TRUE)

# New variable with the price difference between the stores and their competencies in absolute value
df$diff_price <- abs(df$Price - df$CompPrice)
```

# Análisis de la variable precio
### ¿A mayor precio mayor precio de la competencia?
```{r}
plot(x = df$Price, y = df$CompPrice, main="Price VS CompPrice", xlab="Price",ylab="Competence Price", col = alpha("black", 0.5), pch = 19)
```

Hay una clara correlación entre el precio de la tienda y el de su competencia.

### La distribución del precio del asiento del coche según las ventas en las tiendas sean altas, medias o bajas.
```{r}
ggplot(df, aes(x=Sales_cat, y=Price)) + 
    geom_boxplot() + theme_ipsum() +
    labs(title = "Sales level price distribution", x ="Level Sales", y = "Price")
```

El precio del asiento del coche está correlacionado negativamente con las ventas: a menores ventas el precio es más alto.

### ¿Es el precio de los asientos de coches muy distinto en tiendas con ventas bajas en zona rural y urbana?
```{r}
ggplot(df, aes(x=Sales_cat, y=Price, color=Urban)) + scale_color_brewer(palette = "Paired") +
    geom_boxplot() + theme_ipsum() + labs(title = "Sales level price distribution by area", x ="Level Sales", y = "Price")
```

El precio del asiento del coche está correlacionado negativamente con las ventas en las zonas urbanas.
Sin embargo, en zonas rurales, las ventas de categoría media son algo más altas que las ventas de categoría baja.

### ¿A más precio, la diferencia entre el precio del asiento del coche y el de la competencia, es menor?
```{r}
ggplot(df, aes(x=Price, y=diff_price)) + 
    geom_point(
        fill="black",
        shape=21,
        alpha=0.5,
        size=3
        ) + theme_ipsum() + labs(title = "Price VS Price difference between shops and competition", x ="Price", y = "Price difference between shops and competition")
```

Hay una tendencia a que cuanto mayor es el precio menor es la diferencia de precio del asiento del coche con la competencia.

### ¿Cómo se distribuye la diferencia entre el precio del asiento del coche y el precio de la competencia?
```{r}
boxplot(df$diff_price, main = "Car seat price difference between shops and competition")
summary(df$diff_price)
```

3/4 partes tienen una diferencia entre el precio del asiento del coche y el precio de la competencia de 25 dólares o menos.

### ¿El precio de la competencia es mayor si es mayor el precio del asiento del coche en la tienda?
```{r}
plot(x=df$Price, y=df$CompPrice, main
     = "Price VS CompPrice", ylab = "Competence Price", xlab = "Price", col = alpha("black", 0.5), pch = 19)
```

Hay una correlación positiva entre el precio del asiento del coche en la tienda y el precio de su competencia.

### ¿A más ingresos la diferencia entre el precio del asiento del cocche y el de la competencia es menor?
```{r}
ggplot(df, aes(x=Price, y=diff_price, size=Income,color=Income)) + 
    geom_point(alpha=0.5) + theme_ipsum() + scale_color_gradient(low = "#FF410DFF", high = "#6EE2FFFF") +
    labs(title = "Price difference with the competition VS Price VS Income", x ="Price", y = "Price difference with the competition")

df$highlow_income <- ifelse(df$Income >= 91, "high_income","nothigh_income")
ggplot(df, aes(x=Price, y=CompPrice, color=highlow_income)) + 
    geom_point(size=3,alpha=0.7) + theme_ipsum() + scale_color_brewer(palette = "Paired") +
    labs(title = "Competition price VS Price VS Income", x ="Price", y = "Competition price")
```

No hay correlación entre los diferentes ingresos y el precio y la diferencia de precio del asiento del coche con la competencia.

# Análisis de la variable ventas
### ¿Las ventas en dólares son más cuanto más son las unidades vendidas?
```{r}
plot(x=df$Price, y=df$Sales, main = "Price VS Sales",  ylab = "Sales", xlab = "Price", col = alpha("black", 0.5), pch = 19)
```

Hay una clara relación entre precio y ventas.

A mayor precio hay una tendencia a vender menos asientos de los coches.
```{r}
plot(x=df$Price * df$Sales, y=df$Sales, main = "Sales Money VS Sales Quantity",  ylab = "Sales Quantity", xlab = "Sales Money", col = alpha("black", 0.5), pch = 19)
```

A más ventas más dinero.

### ¿Más ventas a más población?
```{r}
plot(x=df$Price * df$Sales, y=df$Population, main = "Sales Money VS Population", ylab = "Population", xlab = "Sales Money", col = alpha("black", 0.5), pch = 19)
```

No hay una correlación entre el número de habitantes y las ventas en dinero.

### ¿Hay ventas más altas si hay más ingresos de la comunidad?
```{r}
plot(x = df$Sales_cat, y = df$Income, main="Sales categories VS Income", xlab="Sales categories",ylab="Income")
```

Hay una clara relación entre las tiendas con ventas muy altas y el ingreso de la comunidad. A más ventas el ingreso de la comunidad es también mayor, y viceversa.

### Nivel de ventas por ingreso y zona
```{r}
ggplot(df, aes(x=Sales_cat, y=Income, color=Urban)) + scale_color_brewer(palette = "Paired") +
    geom_boxplot() + theme_ipsum() + labs(title = "Income distribution by sales level and area", x ="Level Sales", y = "Income")
```

Las tiendas con ventas bajas que están en zona rural tienen, por lo general, clientes con menos ingresos económicos que las tiendas en zonas urbanas.

Las tiendas con ventas medias que están en zona rural tienen, por lo general, clientes con menos ingresos económicos que las tiendas en zonas urbanas.

Las tiendas con ventas muy altas que están en zona rural tienen, por lo general, clientes con menos ingresos económicos que las tiendas en zonas urbanas.

Las tiendas con ventas altas que están en zona rural tienen, por lo general, clientes con mayores ingresos económicos que las tiendas en zonas urbanas.

### De las ventas totales en cada zona, ¿Hay mayor porcentaje de ventas rurales o urbanas según las ventas sean bajas, medias, altas o muy altas?
```{r}
summary(df$Sales)

df_sales_urban <- df %>% group_by(Sales_cat, Urban) %>% summarise(n = n(), .groups = 'drop')
df_sales_urban$per_sales_urban <- ifelse(df_sales_urban$Urban == "Yes",round(df_sales_urban$n/sum(df$Urban == "Yes"),2),round(df_sales_urban$n/sum(df$Urban == "No"),2))

ggplot(df_sales_urban, aes(fill=Urban,x=Sales_cat,y=per_sales_urban)) + 
  geom_bar(stat= "identity", position=position_dodge()) +
  theme_ipsum() + scale_fill_brewer(palette = "Paired") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) + 
  geom_text(aes(label = per_sales_urban), position = position_dodge(0.9),size=2,vjust = 0) + 
  labs(title = "Percentage of stores with different levels of sales according to the area", x ="Sales category", y = "Percent") +
  theme(plot.title=element_text(size=11))
```

Puesto que hay más tiendas en zona urbana que en zona rural no analizo las cantidades si no las proporciones de cada categoría de venta en cada zona.

Casi no hay diferencia en proporciones en ninguna categoría de ventas entre zona urbana y rural.

Las diferencias en proporciones más notables son que proporcionalmente hay más ventas medias en la zona urbana y más ventas altas en la zona rural.

### ¿Cómo son los clientes en las tiendas con ventas altas en zona rural?
```{r}
df_highsales_rural <- filter(df, Sales_cat == "altas" & Urban == "No")
lmts <- range(df_highsales_rural$Education,df$Education)

par(mfrow = c(1, 2))
boxplot(df_highsales_rural$Education,ylim=lmts, main="Education with shops with high sales in a rural area",cex.main=0.75)
boxplot(df$Education,ylim=lmts, main="Education for all shops",cex.main=0.75)
```

La distribución de la educación de los clientes en tiendas con ventas altas y en zona rural es superior, en general, a la distribución de la educación de todos los clientes de todas las tiendas. 
```{r}
lmts <- range(df_highsales_rural$Age,df$Age)

par(mfrow = c(1, 2))
boxplot(df_highsales_rural$Age,ylim=lmts, main="Age with shops with high sales in a rural area",cex.main=0.75)
boxplot(df$Age,ylim=lmts, main="Age for all shops",cex.main=0.75)
```

Hay  más gente joven en las tiendas con ventas altas y zona rural.

¿Cuánta gente más?
```{r}
print("Proporciones de edad de los clientes de tiendas con ventas altas en zona rural")
prop.table(table(df_highsales_rural$Age_cat)); 
print("Proporciones de edad de los clientes para todas las tiendas")
prop.table(table(df$Age_cat))
```
Hay casi un 8% más de jóvenes en las tiendas con ventas altas en zona rural que en todas las tiendas.

Las tiendas con ventas altas en zona rural tienen una comunidad con más ingresos, un 8% más de jóvenes y más educación.

### ¿Las tiendas con ventas altas en zona rural sitúan los asientos de los coches en algún estante en particular?
```{r}
print("Proporciones de estanterías de los asientos de los coches de tiendas con ventas altas en zona rural")
prop.table(table(df_highsales_rural$ShelveLoc));
print("Proporciones de estanterías de los asientos de los coches para todas las tiendas")
prop.table(table(df$ShelveLoc));
```
Tienen proporcionalmente la mitad de asientos de los coches en estantes malos las tiendas con ventas altas en zona rural que todas las tiendas.

### ¿A más ventas el asiento del coche se encuentra en un mejor estante?
```{r}
plot(y = df$Sales, x = df$ShelveLoc, main="Sales VS Shelves", ylab="Sales",xlab="Shelves")
```

A más ventas la localización del estante es mejor.

# Análisis de la variable publicidad
### Hay más gasto de publicidad en zona rural o zona urbana?
```{r}
df %>% group_by(Urban) %>% summarise(mean_ads = mean(Advertising))
```
```{r}
ggplot(df, aes(x=Urban,y=Advertising)) +
    geom_boxplot() + theme_ipsum() + labs(title = "Investment in advertising distribution by area", x ="Urban", y = "Advertising")

summary(filter(df, Urban== "No")$Income)
summary(filter(df, Urban== "Yes")$Income)
```

La distribución de la publicidad en la zona urbana es algo superior.

### ¿A más publicidad más ventas?
```{r}
plot(y = df$Sales, x = df$Advertising, main="Sales VS Advertising", ylab="Sales",xlab="Advertising", col = alpha("black", 0.5), pch = 19)
```

No existe correlación entre ventas y publicidad.

### ¿A mayor precio más inversión en publicidad?
```{r}
plot(y = df$Advertising, x = df$Sales, main="Sales VS Advertising", ylab="Advertising",xlab="Sales", col = alpha("black", 0.5), pch = 19)
```

Hay una ligera correlación positiva a más publicidad más ventas.

### ¿Hay alguna edad en la que haya una correlación más fuerte entre precio y publicidad?
```{r}
ggplot(df,aes(x=Advertising, y=Sales, size=Age, color=Age_cat)) +
    geom_point(alpha=0.5) + theme_ipsum() + scale_color_brewer(palette = "Paired") +
    labs(title = "Advertising VS Sales VS Age")
ggplot(filter(df,Age>=35),aes(x=Advertising, y=Sales, size=Age, color=Age_cat)) +
    geom_point(alpha=0.5) + theme_ipsum() + scale_color_brewer(palette = "Paired") +
    labs(title = "Advertising VS Sales VS Age (greater than 35 years old)")
```

Hay una correlación entre publicidad y ventas para clientes a partir de 35 años.

### ¿Los que no invierten en publicidad venden de media lo mismo que el resto?
```{r}
summary(filter(df,Advertising==0)$Sales)
summary(filter(df,Advertising>0)$Sales)
```
Los que invierten en publicidad venden de media $1000 más que el resto.

### ¿Los que invierten más en publicidad venden asientos de coches dispuestos en mejores estantes?
```{r}
ggplot(filter(df,Age>=35),aes(x=Advertising, y=Sales, size=ShelveLoc, color=ShelveLoc)) +
    geom_point(alpha=0.5) + theme_ipsum() + scale_color_brewer(palette = "Paired") +
    labs(title = "Advertising VS Sales VS Shelves")
```

Hay una clara correlación entre ventas más altas y mejor estante y el resto.

No hay correlación entre publicidad y localización del estante.

# Análisis de la variable ingresos
### ¿Hay más ingresos de la comunidad en zonas rurales o urbanas?
```{r}
ggplot(df, aes(x=Urban,y=Income)) + geom_boxplot() +
    theme_ipsum() + labs(title = "Income distribution by area")
```

La distribución de los ingresos de las comunidades es similar en zona urbana y zona rural.

### La distribución de ingresos por edad y zona
```{r}
ggplot(df, aes(x=Urban, y=Income, color=Age_cat)) + geom_boxplot() +
    theme_ipsum() + scale_color_brewer(palette = "Paired") +
    labs(title = "Income distribution by area and age")
```

Para los clientes entre 25-30, 30-35 y 40-45 años la distribución de ingresos es más compacta en zona rural.

Para los clientes entre 35-40 años la distribución de ingresos es superior en zona rural.

Para los clientes entre 45-65 años la distribución de ingresos es inferior en zona rural.

Para los clientes entre 65-80 años la distribución de ingresos es menos compacta en zona rural.

```{r}
ggplot(df %>% group_by(Age_cat, Urban) %>% summarise(mean_income = mean(Income),.groups='drop'), aes(fill=Urban,x=Age_cat,y=mean_income)) + geom_bar(stat= "identity", position=position_dodge()) + scale_fill_brewer(palette = "Paired") + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) + geom_text(aes(label = round(mean_income,2)), position = position_dodge(0.9),size=2,vjust = 0) + ggtitle("Average income by age range and area") + ylab("Mean Income") + labs(fill = "Urban") + xlab("Age intervals") + theme_ipsum()
```

Los intervalos con mayor diferencia son de 35-40 y 45-65 años.

Los clientes de 35-40 años en zona rural tienen una media de ingresos superior a los que están en zona urbana.

Los clientes de 45-65 años en zona urbana tienen una media de ingresos superior a los que están en zona rural.

### ¿En las tiendas con comunidad con más ingresos hay más inversión de publicidad?
```{r}
plot(x=df$Income, y=df$Advertising, main = "Income VS Advertising", ylab = "Advertising", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay una correlación entre ingresos de la comunidad y publicidad.

### ¿En la tiendas con comunidad con más ingresos el precio de los asientos de coches es más caro?
```{r}
plot(x=df$Income, y=df$Price, main = "Income VS Price", ylab = "Price", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay correlación entre el precio de los car asientos de coches y los ingresos de la comunidad de clientes.

### ¿En la tiendas con comunidad con más ingresos hay clientes más mayores?
```{r}
plot(x=df$Income, y=df$Age, main = "Income VS Age", ylab = "Age", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay correlación entre el ingreso de la comunidad de clientes y las edades de los clientes.

### ¿En la tiendas con comunidad con más ingresos hay clientes con más educación?
```{r}
plot(x=df$Income, y=df$Education, main = "Income VS Education", ylab = "Education", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay correlación entre el ingreso de la comunidad de clientes y la educación de los clientes.

### ¿En la tiendas con comunidad con más ingresos hay tiendas con más ventas?
```{r}
plot(x=df$Income, y=df$Sales, main = "Income VS Sales", ylab = "Sales", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay correlación entre el ingreso de la comunidad de clientes y las ventas.

### ¿En la tiendas con comunidad con más ingresos la disposición de los asientos de coches en los estantes es mejor?
```{r}
plot(x=df$Income, y=df$ShelveLoc, main = "Income VS Shelves", ylab = "Shelves", xlab = "Income", col = alpha("black", 0.5), pch = 19)
```

No hay correlación entre el ingreso de la comunidad de clientes y los estantes en los que se disponen los asientos de coches.

# Análisis de la variable edad de los clientes
### ¿A más edad más educación?
```{r}
df %>% group_by(Age_cat) %>% summarise(median_edu = median(Education),.groups = 'drop')
```
```{r}
print("25-30")
quantile(filter(df, Age_cat == "25-30")$Education);
print("30-35")
quantile(filter(df, Age_cat == "30-35")$Education);
print("35-40")
quantile(filter(df, Age_cat == "35-40")$Education);
print("40-45")
quantile(filter(df, Age_cat == "40-45")$Education);
print("45-65")
quantile(filter(df, Age_cat == "45-65")$Education);
print("65-80")
quantile(filter(df, Age_cat == "65-80")$Education)
```
Los clientes de 40-65 años tienen menos educación que el resto de clientes.

Analizo si esta apreciación tiene que ver con estar o no en zona rural.

### ¿Hay más tiendas con clientes de 40-65 años en zona rural o urbana?
```{r}
prop.table(table(df$Urban))
prop.table(table(filter(df, Age >= 40 & Age <= 65)$Urban))
```
Las tiendas con clientes de 40-65 años tienen el mismo porcentaje en zonas rurales y urbanas que el total de tiendas.

### ¿Hay diferencia de edad de los clientes que compran en zona rural o urbana?
```{r}
df_age_urban <- df %>% group_by(Age_cat,Urban) %>% summarise(n = n(),.groups='drop')
df_age_urban$per_age_urban <- ifelse(df_age_urban$Urban == "Yes", round(df_age_urban$n/sum(df$Urban == "Yes"),2),round(df_age_urban$n/sum(df$Urban == "No"),2))
ggplot(df_age_urban, aes(fill=Urban,x=Age_cat,y=per_age_urban)) + geom_bar(stat= "identity", position=position_dodge()) + 
  scale_fill_brewer(palette = "Paired") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) + 
  geom_text(aes(label = per_age_urban), position = position_dodge(0.9),size=2,vjust = 0) + 
  ggtitle("Percentage of stores with customers of different ages according to the area") + xlab("age") + ylab("percent") + labs(fill = "urban") +
  theme_ipsum() + theme(plot.title=element_text(size=11))

```

No hay mucha diferencia entre los edades de los clientes en zona urbana y rural.

¿Los clientes más jóvenes viven más en la ciudad que el resto?

Dado que hay un 70% de clientes que viven en la ciudad y un 30% de clientes que viven en el campo es lógico que haya más clientes jóvenes viviendo en la ciudad. Sin embargo, analizo de entre todos los que viven en la ciudad qué porcentaje es joven y de entre todos los que viven en el campo qué porcentaje no es joven.

De los que viven en la ciudad el 10% son jóvenes.

De los que viven en el campo el 14% son jóvenes.

Hay casi el mismo porcentaje de jóvenes que viven en la ciudad y en el campo si contamos a los clientes totales rurales por un lado y a los clientes totales urbanos por otro lado.